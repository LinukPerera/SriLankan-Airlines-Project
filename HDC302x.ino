#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_HDC302x.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// Defining LED PINs on the ESP32 Board.
#define On_Board_LED_PIN  2

// --- I2C PIN CONFIGURATION ---
// Bus 0 for OLED Display (Default ESP32 I2C pins)
#define DISPLAY_SDA 21
#define DISPLAY_SCL 22

// Bus 1 for HDC302x Sensor (Your custom wiring)
#define SENSOR_SDA 18
#define SENSOR_SCL 19

// Initialize HDC302x
Adafruit_HDC302x hdc = Adafruit_HDC302x();

// OLED display parameters
#define SCREEN_WIDTH 128 
#define SCREEN_HEIGHT 64 
#define OLED_RESET     -1 

// Initialize Display on the default "Wire" bus
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// // WiFi credentials
// const char* ssid = "DB03IDialog1-24BA";
// const char* password = "32071749"; 
// const char* Room_No = "Store 2";

// WiFi credentials
// const char* ssid = "SIJ";
// const char* password = "yenuk1234"; 
// const char* Room_No = "Store 3";

// WiFi credentials
const char* ssid = "DB03IDialog1-2A6A";
const char* password = "32086309"; 
const char* Room_No = "Store 4";

int Check = 1;
int logo = 1; 

const unsigned char myBitmap[] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd3, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x87, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x3f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x01, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe4, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x30, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x40, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc1, 0x80, 0x03, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0x06, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x06, 0x00, 0x06, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x0c, 0x00, 0x0c, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x18, 0x00, 0x1c, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x30, 0x00, 0x18, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x70, 0x00, 0x38, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0xe0, 0x00, 0x30, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xc0, 0x00, 0x70, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x03, 0x80, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x0e, 0x00, 0x01, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x3c, 0x00, 0x07, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0xf0, 0x00, 0x0f, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x07, 0xc0, 0x00, 0x3c, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x7f, 0x00, 0x01, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xf8, 0x00, 0x07, 0xc0, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x7f, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x03, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xfc, 0x03, 0xff, 0xe3, 0x8f, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xf1, 0xff, 0xff, 0xf3, 0x8f, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xf3, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xf1, 0xff, 0xe0, 0xf3, 0x8f, 0xcf, 0x1c, 0x60, 0x3c, 0xf9, 0xf3, 0x87, 0x10, 0x0f, 0xff, 
  0xff, 0xf8, 0x7f, 0xe3, 0xf3, 0x8f, 0xff, 0x8e, 0x1f, 0x9c, 0xe7, 0xff, 0xe3, 0x0f, 0xc7, 0xff, 
  0xff, 0xff, 0x07, 0xe3, 0xf3, 0x8f, 0xff, 0x8e, 0x7f, 0x9c, 0x8f, 0xff, 0xe3, 0x1f, 0xe7, 0xff, 
  0xff, 0xff, 0xc1, 0xe7, 0xf3, 0x8f, 0xf8, 0x0c, 0x7f, 0x9c, 0x1f, 0xfe, 0x03, 0x1f, 0xe7, 0xff, 
  0xff, 0xff, 0xf0, 0xe7, 0xe3, 0x9f, 0x87, 0x8c, 0xff, 0x98, 0x8f, 0xe3, 0xe7, 0x3f, 0xe7, 0xff, 
  0xff, 0xff, 0xf8, 0xc7, 0xe3, 0x9f, 0x3f, 0x9c, 0xff, 0x98, 0xc7, 0xcf, 0xe7, 0x3f, 0xc7, 0xff, 
  0xff, 0xef, 0xf8, 0xc7, 0xe3, 0x9f, 0x3f, 0x9c, 0xff, 0x98, 0xe3, 0x8f, 0xe7, 0x3f, 0xc7, 0xff, 
  0xff, 0xf1, 0xc3, 0xc7, 0xe3, 0x80, 0x9d, 0x9c, 0xff, 0x98, 0xf9, 0xc7, 0x67, 0x3f, 0xc7, 0xff, 
  0xff, 0xfc, 0x0f, 0xe7, 0xf3, 0xff, 0x0f, 0xdc, 0xff, 0xdc, 0xfc, 0xe1, 0xe7, 0x3f, 0xe7, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xee, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xeb, 0xa7, 0x9b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd6, 0xba, 0xba, 0xd7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xba, 0xba, 0xba, 0x7c, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfa, 0xbe, 0xbb, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

String Web_App_URL = "https://script.google.com/macros/s/AKfycbwCvf5gUXhVz8xE-kkOVkyb6XBuO2Pt0bVk_uJGl78rnIU2OG5FSG57p1vT-6oMBMHEOQ/exec";

String Status_Read_Sensor = "";
String Network_Status = "Connecting...";

float Temp;
int Humd;
int ttl = 0;

void displayCenteredText(const char* text, int y) {
  int16_t x1, y1;
  uint16_t width, height;
  display.getTextBounds(text, 0, y, &x1, &y1, &width, &height);
  int16_t x = (SCREEN_WIDTH - width) / 2;
  display.setCursor(x, y);
  display.print(text);
}

void Getting_Sensor_Data() {
  double tempVal = 0.0;
  double humdVal = 0.0;

  // Read data from HDC302x
  hdc.readTemperatureHumidityOnDemand(tempVal, humdVal, TRIGGERMODE_LP0);

  Temp = (float)tempVal;
  Humd = (int)humdVal;

  if (Temp == 0.0 && Humd == 0) {
      // If values are exactly 0.0, it might be an error or just cold/dry.
      // But if I2C fails, it usually holds previous values or 0.
      Status_Read_Sensor = "Success"; 
  } else {
      Status_Read_Sensor = "Success";
  }
}

void updateDisplay() {
  if(logo == 1){
    display.clearDisplay();
    display.drawBitmap(0, 0, myBitmap, SCREEN_WIDTH, SCREEN_HEIGHT, WHITE);
    display.display();
    delay(2000);
    logo = 0;
  }
    
  display.clearDisplay();
  
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  char tempStr[10];
  snprintf(tempStr, sizeof(tempStr), "Temp:%.2fC", Temp);
  displayCenteredText(tempStr, 0);

  char humdStr[16];
  snprintf(humdStr, sizeof(humdStr), "Hum:%d%%", Humd);
  displayCenteredText(humdStr, 20);

  display.setTextSize(1);
  char statusStr[32];
  snprintf(statusStr, sizeof(statusStr), "Status: %s", Network_Status.c_str());
  displayCenteredText(statusStr, 45);

  display.display();
}

void connectToWiFi() {
  Serial.print("Connecting to ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  int connecting_process_timed_out = 20; 
  connecting_process_timed_out = connecting_process_timed_out * 2;
  
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    digitalWrite(On_Board_LED_PIN, HIGH);
    delay(250);
    digitalWrite(On_Board_LED_PIN, LOW);
    delay(250);
    
    Network_Status = "Connecting...";
    updateDisplay();

    if (connecting_process_timed_out > 0) connecting_process_timed_out--;
    if (connecting_process_timed_out == 0) {
      delay(1000);
      ssid = "SIJ";
      password = "yenuk1234";
      Check = Check + 1;
      WiFi.begin(ssid, password);
      connecting_process_timed_out = 40;
    }
    if (Check > 20) {
      Network_Status = "Network Failed";
      Serial.println("Network connection failed.");
      return;
    }
  }
  
  Network_Status = "Connected";
  Serial.println();
  Serial.println("WiFi connected");
  Serial.println("------------");
}

void setup() {
  Serial.begin(115200);
  Serial.println();
  delay(1000);

  // --- INITIALIZE I2C BUSES ---
  // Bus 0: Display (21, 22)
  Wire.begin(DISPLAY_SDA, DISPLAY_SCL);
  
  // Bus 1: Sensor (18, 19)
  // We explicitly use Wire1 for the second pair of pins
  Wire1.begin(SENSOR_SDA, SENSOR_SCL);

  pinMode(On_Board_LED_PIN, OUTPUT);

  Serial.println("-------------");
  Serial.println("WIFI mode : STA");
  WiFi.mode(WIFI_STA);
  Serial.println("-------------");

  // Start HDC302x on Wire1
  Serial.println();
  Serial.println("HDC302x Begin");
  // Pass &Wire1 to tell the library to use the secondary I2C bus
  if (! hdc.begin(0x44, &Wire1)) {
    Serial.println("Could not find HDC302x sensor!");
    while (1) delay(10);
  }
  Serial.println("HDC302x Found");

  delay(2000);
  
  // Initialize OLED display on Wire (Bus 0)
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;); 
  }
  display.display();
  delay(2000); 
  display.clearDisplay();
  display.display();

  connectToWiFi();
}

void loop() {
  Getting_Sensor_Data();
  updateDisplay();
  
  if (WiFi.status() == WL_CONNECTED) {
    digitalWrite(On_Board_LED_PIN, HIGH);
    
    String Send_Data_URL = Web_App_URL + "?sts=write";
    Send_Data_URL += "&srs=" + Status_Read_Sensor;
    Send_Data_URL += "&temp=" + String(Temp, 2);
    Send_Data_URL += "&humd=" + String(Humd);
    Send_Data_URL += "&swtc1=" + String(Room_No);
    Send_Data_URL += "&swtc2=";
    Send_Data_URL.replace(" ", "%20");

    Serial.println("-------------");
    Serial.println("Send data to Google Spreadsheet...");
    Serial.print("URL : ");
    Serial.println(Send_Data_URL);

    HTTPClient http;
    http.begin(Send_Data_URL);
    http.setFollowRedirects(HTTPC_STRICT_FOLLOW_REDIRECTS);
    int httpCode = http.GET();
    Serial.print("HTTP Status Code : ");
    Serial.println(httpCode);

    if (httpCode > 0) {
      String payload = http.getString();
      Serial.println("Payload : " + payload);
    }

    http.end();

    digitalWrite(On_Board_LED_PIN, LOW);
    Serial.println("-------------");
  } else {
    Network_Status = "Network Failed";
  }

  delay(10000);
  if (ttl > 20) {
    ttl = 0;
    ESP.restart();
  } else {
    ttl = ttl + 1;
  }
  Serial.println(ttl);
}
